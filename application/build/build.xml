<?xml version="1.0" encoding="UTF-8"?>

<project name="MyProject" default="build">

    <property name="buildDir" value="${env.BUILD_DIR}"/>
    <property name="reportsDir" value="${env.REPORTS_DIR}"/>

    <fileset id="srcfiles" dir="..">
        <include name="src/**"/>
        <include name="config/**"/>
        <include name="public/**"/>
        <include name="composer.json"/>
        <include name="composer.lock"/>
        <exclude name="*.tmp"/>
    </fileset>

    <target name="build">

        <echo msg="Building project..."/>

        <mkdir dir="${buildDir}"/>

        <echo msg="Copying files..."/>
        <copy todir="${buildDir}">
            <fileset refid="srcfiles"/>
        </copy>

        <!--<echo msg="Executing composer..."/>-->
        <!--<exec command="COMPOSER_CACHE_DIR=/tmp/composer-cache/ composer install" dir="${buildDir}" passthru="true" checkreturn="true"/>-->

    </target>

    <target name="clean">
        <echo msg="Cleaning build directory..."/>
        <delete dir="${buildDir}" includeemptydirs="true" verbose="true" failonerror="true" quiet="true" />
    </target>

    <target name="deploy" depends="test,build">
        <echo msg="Deploying project..."/>
    </target>

    <target name="test" description="Runs tests" depends="phpunit">
        <!--<echo msg="A fake test message!" />-->
    </target>

    <target name="phpunit" description="Runs phpunit tests">

        <echo msg="Waiting for services..."/>
        <exec command="scripts/wait_for_services.sh" dir=".." passthru="true" checkreturn="true"/>

        <!--<echo msg="Executing composer..."/>-->
        <!--<exec command="COMPOSER_CACHE_DIR=/tmp/composer-cache/ composer install" dir="${buildDir}" passthru="true" checkreturn="true"/>-->

        <echo msg="Creating database..."/>
        <exec command="vendor/bin/doctrine orm:schema-tool:update --force" dir=".." passthru="true" checkreturn="true"/>

        <echo msg="Running phpunit..."/>
        <phpunit
                haltonerror="true"
                haltonfailure="true"
                printsummary="true"
                haltonskipped="true"
                haltonincomplete="true"
                bootstrap="../bootstrap.php"
        >
            <!--<formatter type="plain" usefile="false"/>-->
            <formatter todir="${reportsDir}" type="clover"/>
            <batchtest>
                <fileset dir="../tests/">
                    <include name="*/*Test.php"/>
                </fileset>
            </batchtest>
        </phpunit>
    </target>


</project>